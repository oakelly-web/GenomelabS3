---
title: "Lab 12"
author: "Olivia Kelly"
format:
  html:
    toc: true
    toc_float: true
    code-fold: true
    embed-resources: true
execute:
  warning: false 
  message: false 
---

```{r}
library(neonUtilities)
library(tidyverse)
library(lubridate)
library(DT)
library(viridis)
```

```{r}
library(tidyverse)
library(lubridate)
library(DT)
library(viridis)
```

```{r}
soilChem <- loadByProduct(
  dpID='DP1.10086.001',
  startdate = "2023-01",
  enddate = "2023-12",
  check.size = FALSE,
  package='expanded')
```

```{r}
soilChem$sls_metagenomicsPooling[5,'genomicsSampleID']
```

```{r}
soilChem$sls_metagenomicsPooling[5,'collectDate']
```

```{r}
soilChem$sls_metagenomicsPooling$genomicsPooledIDList[5]
```

```{r}
# View(soilChem$sls_soilChemistry # No soil chemistry data for HARV
soilChem$sls_soilMoisture |> 
  filter(sampleID == "HARV_013-O-39-20230704") |> 
  select(sampleID, soilMoisture)
```

```{r}
# split up the pooled list into new columns
genomicSamples <- soilChem$sls_metagenomicsPooling |>
  tidyr::separate(genomicsPooledIDList, into=c("first","second","third"),sep="\\|",fill="right") |>
  dplyr::select(genomicsSampleID,first,second,third)

head(genomicSamples)
```

```{r}
genSampleExample <- genomicSamples |> 
  tidyr::pivot_longer(cols=c("first","second","third"),values_to = "sampleID") |>
  dplyr::select(sampleID,genomicsSampleID) |>
  drop_na()
```

```{r}
chemEx <- soilChem$sls_soilMoisture |>
  dplyr::select(sampleID,soilMoisture)

## now combine the tables 
combinedTab <- left_join(genSampleExample,chemEx, by = "sampleID") |> drop_na()

## Show the data table
head(combinedTab)
```

```{r}
soilpH_Example <- soilChem$sls_soilpH %>%
  dplyr::filter(sampleID %in% combinedTab$sampleID) %>%
  dplyr::select(sampleID,soilInWaterpH,soilInCaClpH)

# now join with the existing table
combinedTab_pH <- left_join(combinedTab,soilpH_Example, by = "sampleID")

# and the final
head(combinedTab_pH)
```

```{r}
# Remember to install the respirometry package
library(respirometry)

genome_groups_pH <- combinedTab_pH %>%
  group_by(genomicsSampleID) %>%
  summarize_at(c("soilInWaterpH","soilInCaClpH"), mean_pH) 

head(genome_groups_pH)
```

```{r}
genome_groups_all_mean <- combinedTab_pH %>%
  group_by(genomicsSampleID) %>%
  {left_join(
    summarize_at(.,vars("soilMoisture"), mean),
    summarize_at(.,vars("soilInWaterpH","soilInCaClpH"), mean_pH)
  )}

head(genome_groups_all_mean)
```

## **Exercises**

### **Exercise** 1.

The dataframe sls_soilCoreCollection contains alot of useful information for analyzing the NEON MAGs. Create a new dataframe `coreCollectionSubset` with just the following columns

-   sampleID

-   decimalLatitude

-   decimalLongitude

-   elevation

-   soilTemp

```{r}
coreCollectionSubset <- soilChem$sls_soilCoreCollection[, c("sampleID","decimalLatitude", "decimalLongitude", "elevation", "soilTemp")]

 head(coreCollectionSubset)
```

### **Exercise 2**

Following the above examples with `chemEx` join `genSampleExample` and `coreCollectionSubset`.

```{r}
library(dplyr)

combinedTab <- left_join(genSampleExample, chemEx, by = "sampleID") %>%
  drop_na()

combinedTab_full <- left_join(combinedTab, coreCollectionSubset, by = "sampleID")

head(combinedTab_full)

```

### **Exercise 3**

Get the mean for each mean for each metagenome `genomicsSampleID` for each column in your data frame from Ex. 2.

```{r}

genome_groups_all_mean <- combinedTab_full %>%
  group_by(genomicsSampleID) %>%
  summarize(
    soilMoisture     = mean(soilMoisture, na.rm = TRUE),
    decimalLatitude  = mean(decimalLatitude, na.rm = TRUE),
    decimalLongitude = mean(decimalLongitude, na.rm = TRUE),
    elevation        = mean(elevation, na.rm = TRUE),
    soilTemp         = mean(soilTemp, na.rm = TRUE)
  )

head(genome_groups_all_mean)

```

### **Exercise 4**

Join the data frame from Ex. 3 with the soil moisture and pH measurements in `genome_groups_all_mean`.

```{r}
combinedTab_all <- left_join(combinedTab_full, soilpH_Example, by = "sampleID")

genome_groups_all_mean <- combinedTab_all %>%
  group_by(genomicsSampleID) %>%
  summarize(
    soilMoisture     = mean(soilMoisture, na.rm = TRUE),
    soilInWaterpH    = mean_pH(soilInWaterpH),
    soilInCaClpH     = mean_pH(soilInCaClpH),
    decimalLatitude  = mean(decimalLatitude, na.rm = TRUE),
    decimalLongitude = mean(decimalLongitude, na.rm = TRUE),
    elevation        = mean(elevation, na.rm = TRUE),
    soilTemp         = mean(soilTemp, na.rm = TRUE)
  )

head(genome_groups_all_mean)


```

### **Exercise 5**

Using the `genomicsSampleID` column, make a new column with the siteID (e.g. HARV). There is a similar example in lab 6 where we parsed the NEON MAG data.

```{r}
genome_groups_all_mean <- genome_groups_all_mean %>%
  mutate(siteID = sub("_.*", "", genomicsSampleID))

head(genome_groups_all_mean)

```

### **Exercise 6**

Make a box plot with the soilpH by siteID

```{r}
ggplot(genome_groups_all_mean, aes(x = siteID, y = soilInWaterpH)) +
  geom_boxplot(fill = "skyblue", color = "pink") +
  labs(
    title = "Distribution of Soil pH by Site",
    x = "Site ID",
    y = "Soil pH (in water)"
  ) +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### **Exercise 7**

Calculate the mean soilTemp and soilMoisture for each siteID. Make a graph of mean soilTemp vs soilMoisture

```{r}
site_means <- genome_groups_all_mean %>%
  group_by(siteID) %>%
  summarize(
    mean_soilTemp = mean(soilTemp, na.rm = TRUE),
    mean_soilMoisture = mean(soilMoisture, na.rm = TRUE)
  )

ggplot(site_means, aes(x = mean_soilTemp, y = mean_soilMoisture, label = siteID)) +
  geom_point(color = "pink", size = 3) +
  geom_text(vjust = 1, size = 2) +
  labs(
    title = "Mean Soil Temperature vs Soil Moisture by Site",
    x = "Mean Soil Temperature (°C)",
    y = "Mean Soil Moisture (%)"
  ) +
  theme_minimal()
```

### **Exercise 8**

Join your data frame from Ex 4 with the `NEON_MAGs_soil` data frame from lab 6.

```{r}

NEON_MAGs_soil <- read_tsv("/work/pi_bio678_umass_edu/data_NEON/exported_img_bins_Gs0166454_NEON.tsv")

```

```{r}
NEON_MAGs_prelim <- read_tsv("/work/pi_bio678_umass_edu/data_NEON/exported_img_bins_Gs0166454_NEON.tsv")
colnames(NEON_MAGs_soil)

```

```{r}
colnames(NEON_MAGs_soil)

```

```{r}
library(dplyr)
library(stringr)
library(readr)

NEON_MAGs_soil <- read_tsv("/work/pi_bio678_umass_edu/data_NEON/exported_img_bins_Gs0166454_NEON.tsv")

NEON_MAGs_soil <- NEON_MAGs_soil %>%
  mutate(Genome_Name_clean = str_replace_all(`Genome Name`, "-COMP", ""))

genome_MAGs_joined <- left_join(
  genome_groups_all_mean,
  NEON_MAGs_soil,
  by = c("genomicsSampleID" = "Genome_Name_clean")
)

head(genome_MAGs_joined)


```

```{r}
summary(genome_MAGs_joined)

```

### **Exercise 9**

```{r}
soilpH_Example <- soilChem$sls_soilpH %>%
  dplyr::filter(sampleID %in% combinedTab$sampleID) %>%
  dplyr::select(sampleID,soilInWaterpH,soilInCaClpH)

combinedTab_pH <- left_join(combinedTab,soilpH_Example, by = "sampleID")

head(combinedTab_pH)
```

```{r}
library(respirometry)

genome_groups_pH <- combinedTab_pH %>%
  group_by(genomicsSampleID) %>%
  summarize_at(c("soilInWaterpH","soilInCaClpH"), mean_pH) 

head(genome_groups_pH)
```

Make a table of the MAGs found in soils with a pH \< 4.0.

```{r}
grep("pH", colnames(genome_MAGs_joined), value = TRUE)


```

```{r}
library(dplyr)

MAGs_low_pH <- genome_MAGs_joined %>%
  filter(soilInWaterpH < 4 | soilInCaClpH < 4) %>%
  select(genomicsSampleID, `Genome Name`, soilInWaterpH, soilInCaClpH)

MAGs_low_pH



```
